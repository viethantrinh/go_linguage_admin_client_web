<div class="container-lg">
  <div class="mb-4 text-center">
    <h1 class="h3 text-primary">Hệ Thống Tạo Bài Hát</h1>
    <p class="text-medium-emphasis">Tạo bài hát bằng công nghệ AI</p>
  </div>

  <!-- Steps Progress -->
  <div class="row mb-5 justify-content-center">
    <div class="col-12 px-4">
      <div class="d-flex align-items-center w-100">
        <!-- Step 1 -->
        <div class="position-relative">
          <div [ngClass]="currentStep > 1 ? 'bg-success text-white' : (currentStep === 1 ? 'bg-primary text-white' : 'bg-light text-medium-emphasis')"
               class="d-flex align-items-center justify-content-center rounded-circle" 
               style="width: 40px; height: 40px; font-weight: 600;">
            1
          </div>
          <div class="position-absolute start-50 translate-middle-x" style="white-space: nowrap; bottom: -24px; font-size: 0.875rem;">
            Tên bài hát
          </div>
        </div>
        <div class="flex-grow-1 mx-2" 
             [ngClass]="currentStep > 1 ? 'bg-success' : 'bg-light'" 
             style="height: 2px;"></div>
        
        <!-- Step 2 -->
        <div class="position-relative">
          <div [ngClass]="currentStep > 2 ? 'bg-success text-white' : (currentStep === 2 ? 'bg-primary text-white' : 'bg-light text-medium-emphasis')"
               class="d-flex align-items-center justify-content-center rounded-circle" 
               style="width: 40px; height: 40px; font-weight: 600;">
            2
          </div>
          <div class="position-absolute start-50 translate-middle-x" style="white-space: nowrap; bottom: -24px; font-size: 0.875rem;">
            Tạo lời
          </div>
        </div>
        <div class="flex-grow-1 mx-2" 
             [ngClass]="currentStep > 2 ? 'bg-success' : 'bg-light'" 
             style="height: 2px;"></div>

        <!-- Step 3 -->
        <div class="position-relative">
          <div [ngClass]="currentStep > 3 ? 'bg-success text-white' : (currentStep === 3 ? 'bg-primary text-white' : 'bg-light text-medium-emphasis')"
               class="d-flex align-items-center justify-content-center rounded-circle" 
               style="width: 40px; height: 40px; font-weight: 600;">
            3
          </div>
          <div class="position-absolute start-50 translate-middle-x" style="white-space: nowrap; bottom: -24px; font-size: 0.875rem;">
            Tạo audio
          </div>
        </div>
        <div class="flex-grow-1 mx-2" 
             [ngClass]="currentStep > 3 ? 'bg-success' : 'bg-light'" 
             style="height: 2px;"></div>

        <!-- Step 4 -->
        <div class="position-relative">
          <div [ngClass]="currentStep > 4 ? 'bg-success text-white' : (currentStep === 4 ? 'bg-primary text-white' : 'bg-light text-medium-emphasis')"
               class="d-flex align-items-center justify-content-center rounded-circle" 
               style="width: 40px; height: 40px; font-weight: 600;">
            4
          </div>
          <div class="position-absolute start-50 translate-middle-x" style="white-space: nowrap; bottom: -24px; font-size: 0.875rem;">
            Alignment
          </div>
        </div>
        <div class="flex-grow-1 mx-2" 
             [ngClass]="currentStep > 4 ? 'bg-success' : 'bg-light'" 
             style="height: 2px;"></div>

        <!-- Step 5 -->
        <div class="position-relative">
          <div [ngClass]="currentStep > 5 ? 'bg-success text-white' : (currentStep === 5 ? 'bg-primary text-white' : 'bg-light text-medium-emphasis')"
               class="d-flex align-items-center justify-content-center rounded-circle" 
               style="width: 40px; height: 40px; font-weight: 600;">
            5
          </div>
          <div class="position-absolute start-50 translate-middle-x" style="white-space: nowrap; bottom: -24px; font-size: 0.875rem;">
            Lưu trữ
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content Area -->
  <c-card class="mt-5" style="min-height: 460px;">
    <c-card-body>
      <!-- Step 1: Song Name Input -->
      <div *ngIf="currentStep === 1">
        <h2 class="h5 mb-4">Bước 1: Nhập tên bài hát</h2>
        <form [formGroup]="songForm">
          <div class="mb-3">
            <label for="songTitle" cLabel>Tên bài hát</label>
            <input cFormControl id="songTitle" formControlName="songTitle" placeholder="Nhập tên bài hát...">
          </div>
          
          <div class="mb-3" formGroupName="genres">
            <label cLabel>Thể loại</label>
            <div class="row g-3">
              <div class="col-md-3">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="pop" formControlName="pop">
                  <label class="form-check-label" for="pop">Pop</label>
                </div>
              </div>
              <div class="col-md-3">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="rock" formControlName="rock">
                  <label class="form-check-label" for="rock">Rock</label>
                </div>
              </div>
              <div class="col-md-3">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="ballad" formControlName="ballad">
                  <label class="form-check-label" for="ballad">Ballad</label>
                </div>
              </div>
              <div class="col-md-3">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="rap" formControlName="rap">
                  <label class="form-check-label" for="rap">Rap</label>
                </div>
              </div>
              <div class="col-md-3">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="electronic" formControlName="electronic">
                  <label class="form-check-label" for="electronic">Electronic</label>
                </div>
              </div>
              <div class="col-md-3">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="folk" formControlName="folk">
                  <label class="form-check-label" for="folk">Folk</label>
                </div>
              </div>
              <div class="col-md-3">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="rnb" formControlName="rnb">
                  <label class="form-check-label" for="rnb">R&B</label>
                </div>
              </div>
              <div class="col-md-3">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="jazz" formControlName="jazz">
                  <label class="form-check-label" for="jazz">Jazz</label>
                </div>
              </div>
            </div>
          </div>
          
          <div class="mb-3">
            <label for="keywords" cLabel>Từ khóa liên quan</label>
            <textarea cFormControl id="keywords" formControlName="keywords" rows="3" 
                     placeholder="Nhập các từ khóa phù hợp với chủ đề bài hát, cách nhau bởi dấu phẩy..."></textarea>
            <small class="text-medium-emphasis">Các từ khóa giúp AI tạo lời bài hát chính xác hơn</small>
          </div>
        </form>
      </div>

      <!-- Step 2: Lyrics Generation -->
      <div *ngIf="currentStep === 2">
        <h2 class="h5 mb-4">Bước 2: Tạo lời bài hát</h2>
        <div *ngIf="lyricsLoading" class="py-4 text-center">
          <c-spinner color="primary" style="width: 3rem; height: 3rem;"></c-spinner>
          <p class="mt-3">Đang tạo lời bài hát bằng Groq AI...</p>
          <p class="text-medium-emphasis small">Quá trình này có thể mất vài giây đến một phút</p>
        </div>
        
        <div *ngIf="!lyricsLoading" class="lyrics-content">
          <div class="row g-4 mb-4">
            <div class="col-md-6">
              <h5>Lời tiếng Anh</h5>
              <div class="border rounded p-3 bg-light" style="height: 220px; overflow-y: auto; white-space: pre-line;">
                {{ englishLyrics }}
              </div>
            </div>
            <div class="col-md-6">
              <h5>Lời tiếng Việt</h5>
              <div class="border rounded p-3 bg-light" style="height: 220px; overflow-y: auto; white-space: pre-line;">
                {{ vietnameseLyrics }}
              </div>
            </div>
          </div>
          <div class="d-flex justify-content-between">
            <button cButton color="light" variant="outline" (click)="regenerateLyrics()">
              <svg cIcon name="cilReload" class="me-2"></svg> Tạo lại
            </button>
            <button cButton color="primary" variant="outline">
              <svg cIcon name="cilPencil" class="me-2"></svg> Chỉnh sửa
            </button>
          </div>
        </div>
      </div>

      <!-- Step 3: Audio Generation -->
      <div *ngIf="currentStep === 3">
        <h2 class="h5 mb-4">Bước 3: Tạo file audio</h2>
        <div *ngIf="audioLoading" class="py-4 text-center">
          <c-spinner color="primary" style="width: 3rem; height: 3rem;"></c-spinner>
          <p class="mt-3">Đang tạo file audio bằng Suno AI...</p>
          <p class="text-medium-emphasis small">Quá trình này có thể mất 1-3 phút</p>
          
          <div class="mt-4 w-100 mx-auto" style="max-width: 500px;">
            <c-progress class="mb-3">
              <c-progress-bar [value]="audioProgress"></c-progress-bar>
            </c-progress>
            <small>{{ audioProgress }}%</small>
          </div>
        </div>
        
        <div *ngIf="!audioLoading" class="text-center py-4">
          <h5 class="mb-4">Bài hát đã được tạo thành công</h5>
          <div class="mb-4 mx-auto" style="max-width: 500px;">
            <audio controls class="w-100">
              <source [src]="audioUrl" type="audio/mpeg">
              Trình duyệt của bạn không hỗ trợ phát audio.
            </audio>
          </div>
          <button cButton color="light" variant="outline" (click)="regenerateAudio()">
            <svg cIcon name="cilReload" class="me-2"></svg> Tạo lại
          </button>
        </div>
      </div>

      <!-- Step 4: Alignment Process -->
      <div *ngIf="currentStep === 4">
        <h2 class="h5 mb-4">Bước 4: Xử lý alignment</h2>
        <div *ngIf="alignmentLoading" class="py-4 text-center">
          <c-spinner color="primary" style="width: 3rem; height: 3rem;"></c-spinner>
          <p class="mt-3">Đang xử lý force alignment...</p>
          <p class="text-medium-emphasis small">Trích xuất word-level timestamp</p>
        </div>
        
        <div *ngIf="!alignmentLoading">
          <h5 class="mb-3">Word-level alignment</h5>
          <div class="border rounded p-4 bg-light mb-4">
            <div class="p-2 text-center">
              <ng-container *ngFor="let item of wordTimings">
                <span class="word-timing" [attr.data-start]="item.start" [attr.data-end]="item.end" (click)="playWordAudio(item.start)">
                  {{ item.word }}
                </span>
              </ng-container>
            </div>
          </div>
          
          <div class="mt-4">
            <audio id="aligned-audio" controls class="w-100">
              <source [src]="audioUrl" type="audio/mpeg">
              Trình duyệt của bạn không hỗ trợ phát audio.
            </audio>
          </div>
        </div>
      </div>

      <!-- Step 5: Save to Database -->
      <div *ngIf="currentStep === 5">
        <h2 class="h5 mb-4">Bước 5: Lưu trữ bài hát</h2>
        <div *ngIf="saveLoading" class="py-4 text-center">
          <c-spinner color="primary" style="width: 3rem; height: 3rem;"></c-spinner>
          <p class="mt-3">Đang tải lên Cloudinary và lưu trữ...</p>
        </div>
        
        <div *ngIf="!saveLoading">
          <c-alert color="success" class="mb-4">
            <svg cIcon name="cilCheckCircle" class="me-2"></svg>
            <strong>Lưu trữ thành công</strong>
            <div class="mt-2">Bài hát đã được lưu vào cơ sở dữ liệu và sẵn sàng sử dụng.</div>
          </c-alert>

          <div class="bg-light p-4 rounded mb-4">
            <h5 class="mb-3">Thông tin bài hát</h5>
            <div class="row g-3">
              <div class="col-md-6">
                <p class="mb-1 text-medium-emphasis small">Tên bài hát</p>
                <p class="mb-0">{{ songForm.get('songTitle')?.value || '-' }}</p>
              </div>
              <div class="col-md-6">
                <p class="mb-1 text-medium-emphasis small">Thể loại</p>
                <p class="mb-0">{{ getSelectedGenres().join(', ') || 'Không xác định' }}</p>
              </div>
              <div class="col-12">
                <p class="mb-1 text-medium-emphasis small">URL Cloudinary</p>
                <p class="mb-0 text-break">{{ audioUrl || 'https://res.cloudinary.com/demo/video/upload/v1234567890/example_song.mp3' }}</p>
              </div>
              <div class="col-12">
                <p class="mb-1 text-medium-emphasis small">Lời bài hát</p>
                <p class="mb-0">{{ englishLyrics.split('\n')[0] }}...</p>
              </div>
            </div>
          </div>
          
          <div class="text-center">
            <button cButton color="primary" (click)="resetForm()">
              Tạo bài hát mới
            </button>
          </div>
        </div>
      </div>
    </c-card-body>
  </c-card>

  <!-- Navigation Buttons -->
  <div class="d-flex justify-content-between mt-4">
    <button 
      cButton 
      color="light" 
      variant="outline" 
      *ngIf="currentStep > 1" 
      (click)="prevStep()">
      <svg cIcon name="cilArrowLeft" class="me-2"></svg> Quay lại
    </button>
    <button 
      cButton 
      color="primary" 
      *ngIf="currentStep < totalSteps" 
      (click)="nextStep()">
      <ng-container *ngIf="currentStep === 1">Tạo lời bài hát</ng-container>
      <ng-container *ngIf="currentStep === 2">Tạo file audio</ng-container>
      <ng-container *ngIf="currentStep === 3">Xử lý alignment</ng-container>
      <ng-container *ngIf="currentStep === 4">Lưu trữ</ng-container>
      <svg cIcon name="cilArrowRight" class="ms-2"></svg>
    </button>
  </div>
</div>
